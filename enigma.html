<html>
    <head>
        <title>
            ENIGMA
        </title>
        <style>

            article{
                text-align: center;
                justify-content: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                background-color: rgb(79, 26, 26);
                width: 800px;
            }
            #rotors{
                display: flex;
                background-color: brown;
                width: 600px;
                height: 200px;
                padding: 10px;
            }
            .r{
                /* flex-grow: 1;   */
                flex: 1;
                flex-direction: row;
                background-color: white;
                margin:10px;
            }
            .r > div {
                text-align: center;
                height: 33%;
                line-height: 60px;
                border: 1px solid black;
                font-weight: bold;
                font-size: 30px;
                background-color: rgb(187, 187, 187);
            }
            .r-1{
                border-bottom: 1px solid black;
            }
            .r-2{
                border-bottom: 1px solid black;
            }

            #arrow{
                display: inline-block;
                position: relative;
                background-color: lightgray;
                top: 45%;
                padding: 2px;
                height: 15px;
            }

            .wheel{
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .keyboard{
                display: flex;
                flex-direction: column;
                align-items: center;
                background-color: brown;
                padding: 10px; 
            }
            .keyboard > div{
                display: flex;
                flex-direction: row;
            }
            .keyboard > div > div {
                border: 2px solid black;
                width: 40px; 
                height: 40px;
                margin: 5px;
                background-color: white;
                padding: 5px;
                text-align: center;
                line-height: 40px;
                font-size: 21px;
                font-weight: 700;
                border-radius: 50%;
            }

            #lamp > div > div{
                /* background-color: */
                background-color:lemonchiffon
            }

            #input{
                border-top: 3px solid black;
            }

            #reflector{
                border: 5px solid black;
                background-color: rgb(60, 6, 6);
            }
            #reflector > div > div{
                width: 30px;
                height: 30px;
            }
            
        </style>
    </head>
    <body>
        <header>
            <h1>Enigma</h1>
            <h4>
                에니그마는 독일이 2차 세계대전에 사용한 암호화 기계로 송신자와 수신자간에 규칙을 통해 서로 암호를 교환하는 방식을 사용한다.
            </h4>
            <ul>
                <li>각 날짜마다 초기 세팅을 위한 설정을 배포받는다</li>
                <li>송신자가 초기 세팅을 한다</li>
                <li>송신자가 원하는 세글자 단어를 선정 해, 그 단어로 다시 초기 세팅을 한다</li>
                <li>(초기 세팅으로 암호화)송신자가 선정한 단어 * 2 + (송신자가 선정한 단어로 암호화)메세지 를 수신자에게 전송한다</li>
            </ul>
            <h3>
                해당 토이 프로젝트에서 회전자의 순서를 단순히 A-Z를 연속으로 나열한 순서지만 실제 전쟁에서 사용했던 회전자는 매우 복잡하게 순서가 뒤바껴있었다.
                <h5>출처 - 나무위키 (https://namu.wiki/w/%EC%97%90%EB%8B%88%EA%B7%B8%EB%A7%88(%EA%B8%B0%EA%B3%84)) </h5>
                <h4>당시 회전자의 종류</h4>
                <ul>
                    <li>EKMFLGDQVZNTOWYHXUSPAIBRCJ</li>
                    <li>AJDKSIRUXBLHWTMCQGZNPYFVOE</li>
                    <li>BDFHJLCPRTXVZNYEIWGAKMUSQO</li>
                    <li>ESOVPZJAYQUIRHXLNFTGKDCMWB</li>
                    <li>VZBRGITYUPSDNHLXAWMJQOFECK</li>
                    <li>JPGVOUMFYQBENHZRDKASXLICTW</li>
                    <li>NZJHGRCXMYSWBOUFAIVLPEKQDT</li>
                    <li>FKQHTLXOCBJSPDZRAMEWNIUYGV</li>
                </ul>
            </h3>

            <img src="https://t1.daumcdn.net/cfile/tistory/991C5A405BFBA44507" alt="" srcset="">
        </header>
        <article>
            rotors
            <div id="rotors">
                <div id="arrow">➡︎</div>
                <div class="r" id="r1">
                    <div id="r1_1">A</div>
                    <div id="r1_2">B</div>
                    <div id="r1_3">C</div>
                </div>
                <div class="wheel" id="w1">
                    <input id=w1_up type="button" value="⬆" >
                    <input id=w1_down type="button" value="⬇︎">
                </div>
                <div class="r" id="r2">
                    <div id="r2_1">Z</div>
                    <div id="r2_2">B</div>
                    <div id="r2_3">C</div>
                </div>
                <div class="wheel" id="w2">
                    <input id=w2_up type="button" value="⬆">
                    <input id=w2_down type="button" value="⬇︎">
                </div>
                <div class="r" id="r3">
                    <div id="r3_1">A</div>
                    <div id="r3_2">B</div>
                    <div id="r3_3">C</div>
                </div>
                <div class="wheel" id="w3">
                    <input id=w3_up type="button" value="⬆">
                    <input id=w3_down type="button" value="⬇︎">
                </div>
            </div>
            lampboard
            <div id="lampboard">

            </div>

            <div class='keyboard' id="lamp">
                <div>
                    <div id="Q">Q</div>
                    <div id="W">W</div>
                    <div id="E">E</div>
                    <div>R</div>
                    <div>T</div>
                    <div>Y</div>
                    <div>U</div>
                    <div>I</div>
                    <div>O</div>
                    <div>P</div>
                </div>
                <div>
                    <div>A</div>
                    <div>S</div>
                    <div>D</div>
                    <div>F</div>
                    <div>G</div>
                    <div>H</div>
                    <div>J</div>
                    <div>K</div>
                    <div>L</div>
                </div>
                <div>
                    <div>Z</div>
                    <div>X</div>
                    <div>C</div>
                    <div>V</div>
                    <div>B</div>
                    <div>N</div>
                    <div>M</div>
                </div>
            </div>


            <div class='keyboard' id="input">
                <div>
                    <div>Q</div>
                    <div>W</div>
                    <div>E</div>
                    <div>R</div>
                    <div>T</div>
                    <div>Y</div>
                    <div>U</div>
                    <div>I</div>
                    <div>O</div>
                    <div>P</div>
                </div>
                <div>
                    <div>A</div>
                    <div>S</div>
                    <div>D</div>
                    <div>F</div>
                    <div>G</div>
                    <div>H</div>
                    <div>J</div>
                    <div>K</div>
                    <div>L</div>
                </div>
                <div>
                    <div>Z</div>
                    <div>X</div>
                    <div>C</div>
                    <div>V</div>
                    <div>B</div>
                    <div>N</div>
                    <div>M</div>
                </div>
            </div>

            <!-- <input type="text" name="" id="inputboard"> -->

            <div class='keyboard' id="reflector">
                <div>
                    <div>Q</div>
                    <div>W</div>
                    <div>E</div>
                    <div>R</div>
                    <div>T</div>
                    <div>Y</div>
                    <div>U</div>
                    <div>I</div>
                    <div>O</div>
                    <div>P</div>
                </div>
                <div>
                    <div>A</div>
                    <div>S</div>
                    <div>D</div>
                    <div>F</div>
                    <div>G</div>
                    <div>H</div>
                    <div>J</div>
                    <div>K</div>
                    <div>L</div>
                </div>
                <div>
                    <div>Z</div>
                    <div>X</div>
                    <div>C</div>
                    <div>V</div>
                    <div>B</div>
                    <div>N</div>
                    <div>M</div>
                </div>
            </div>
        </article>
    </body>
    <script>

        //create lampboard
        let lampboard = document.getElementById("lampboard")
        let lampboard_btns = []
        for(let i=0; i<26; i++){
            lampboard_btns[i] = document.createElement("button")
            lampboard_btns[i].innerText = String.fromCharCode('A'.charCodeAt()+i)
            lampboard.appendChild(lampboard_btns[i])
            console.log(lampboard_btns[i].innerText)
        }

        // add pointers to each rotors
        let r = []
        for(let i=0; i<26; i++){
            r[i] = String.fromCharCode('A'.charCodeAt()+i)
        }
        let ptr_r1 = 0
        let ptr_r2 = 0
        let ptr_r3 = 0

        // rotor variables 
        let r1_1 = document.getElementById("r1_1")
        let r1_2 = document.getElementById("r1_2")
        let r1_3 = document.getElementById("r1_3")

        let r2_1 = document.getElementById("r2_1")
        let r2_2 = document.getElementById("r2_2")
        let r2_3 = document.getElementById("r2_3")

        let r3_1 = document.getElementById("r3_1")
        let r3_2 = document.getElementById("r3_2")
        let r3_3 = document.getElementById("r3_3")

        // add wheel event listener 
        let upWheel = (ptr)=>{
            return ptr==0 ? 25 : ptr-1
        }
        let downWheel = (ptr)=>{
            return ptr==25 ? 0 : ptr+1
        }
        
        let update = ()=>{
            r1_1.innerText = ptr_r1==0 ? 'Z' : String.fromCharCode('A'.charCodeAt()+ptr_r1-1)
            r1_2.innerText = String.fromCharCode('A'.charCodeAt()+ptr_r1)  
            r1_3.innerText = ptr_r1==25 ? 'A' : String.fromCharCode('A'.charCodeAt()+ptr_r1+1)

            r2_1.innerText = ptr_r2==0 ? 'Z' : String.fromCharCode('A'.charCodeAt()+ptr_r2-1)
            r2_2.innerText = String.fromCharCode('A'.charCodeAt()+ptr_r2)  
            r2_3.innerText = ptr_r2==25 ? 'A' : String.fromCharCode('A'.charCodeAt()+ptr_r2+1)

            r3_1.innerText = ptr_r3==0 ? 'Z' : String.fromCharCode('A'.charCodeAt()+ptr_r3-1)
            r3_2.innerText = String.fromCharCode('A'.charCodeAt()+ptr_r3)  
            r3_3.innerText = ptr_r3==25 ? 'A' : String.fromCharCode('A'.charCodeAt()+ptr_r3+1)
        }

        let w1_up = document.getElementById("w1_up")
        let w1_down = document.getElementById("w1_down")
        w1_up.addEventListener('click', ()=>{
            ptr_r1 = upWheel(ptr_r1)
            update()
        })
        w1_down.addEventListener('click', ()=>{
            ptr_r1 = downWheel(ptr_r1)
            update()
        })

        let w2_up = document.getElementById("w2_up")
        let w2_down = document.getElementById("w2_down")
        w2_up.addEventListener('click', ()=>{
            ptr_r2 = upWheel(ptr_r2)
            update()
        })
        w2_down.addEventListener('click', ()=>{
            ptr_r2 = downWheel(ptr_r2)
            update()
        })



        let w3_up = document.getElementById("w3_up")
        let w3_down = document.getElementById("w3_down")
        w3_up.addEventListener('click', ()=>{
            ptr_r3 = upWheel(ptr_r3)
            update()
        })
        w3_down.addEventListener('click', ()=>{
            ptr_r3 = downWheel(ptr_r3)
            update()
        })

        update()


        //reflector

        let reflector = document.getElementById("reflector")
        let refArr = []
        let tmp = [] // max 2
        function generateRandomCode() {
            let myRandomColor = '#' + Math.floor(Math.random() * 16777215).toString(16);
            return myRandomColor;
        }
        let color = generateRandomCode()

        for(let i=0; i<26; i++){
            refArr[i] = String.fromCharCode('A'.charCodeAt() + i)
        }

        // add event to reflector keyboard
        let reflectorClick = (r)=>{
            tmp[tmp.length] = r
            if(tmp.length == 2){
                let n1 = tmp[0].charCodeAt()-'A'.charCodeAt()
                let n2 = tmp[1].charCodeAt()-'A'.charCodeAt() 
                refArr[n1] = tmp[1]
                refArr[n2] = tmp[0]

                console.log(tmp)
                tmp = []
                console.log(refArr)

                color = generateRandomCode()
            }
        }

        for(let i=0; i<reflector.children.length; i++){
            for(let j=0; j<reflector.children[i].childElementCount; j++){
                reflector.children[i].children[j].addEventListener('click', ()=>{
                    reflector.children[i].children[j].style.backgroundColor = color
                    reflectorClick(reflector.children[i].children[j].innerText)
                })
            }
        }


        // transform
        let transform = (p)=>{
            let rotorTransform = (param, ptr1, ptr2)=>{
                param = param.charCodeAt()-'A'.charCodeAt()
                let diff = param > ptr1 ? param - ptr1 : 26-(ptr1-param)
                return String.fromCharCode('A'.charCodeAt() + (ptr2+diff)%26)
            }
            // p는 변환이 필요한 글자

            //로터 3,2,1 순서로 변횐된다
            // rotor3
            p = rotorTransform(p, 0, ptr_r3)
            console.log(p)
            // rotor2
            p = rotorTransform(p, ptr_r3, ptr_r2)
            console.log(p)
            // rotor1
            p = rotorTransform(p, ptr_r2, ptr_r1)
            console.log(p)

            // 반사
            p = p.charCodeAt() - 'A'.charCodeAt()
            p = refArr[p]

            // rotor1
            p = rotorTransform(p, ptr_r1, ptr_r2)
            console.log(p)
            // rotor2
            p = rotorTransform(p, ptr_r2, ptr_r3)
            console.log(p)
            //rotor3
            p = rotorTransform(p, ptr_r3, 0)
            console.log(p)

            p = p.charCodeAt() - 'A'.charCodeAt()
            return refArr[p]
        }

        // after transform rotate
        let rotate = ()=>{
            ptr_r3 += 1
            if (ptr_r3 == 26){
                ptr_r2 += 1
                ptr_r3 %= 26
            }
            if (ptr_r2 == 26){
                ptr_r1 += 1
                ptr_r1 %= 26
            }
        }

        // lamp 
        let lamp = document.getElementById('lamp')
        for(let i=0; i<lamp.children.length; i++){
            for(let j=0; j<lamp.children[i].childElementCount; j++){
                lamp.children[i].children[j].id = lamp.children[i].children[j].innerText
            }
        }
        // input keyboard
        let input = document.getElementById('input')
        for(let i=0; i<input.children.length; i++){
            for(let j=0; j<input.children[i].childElementCount; j++){
                let p = input.children[i].children[j].innerText;
                let lampBtn

                input.children[i].children[j].addEventListener('mousedown', ()=>{
                    input.children[i].children[j].style.backgroundColor = 'grey'
                    // console.log(transform(p))
                    lampBtn = document.getElementById(transform(p))
                    lampBtn.style.backgroundColor = 'orange'
                })
                input.children[i].children[j].addEventListener('mouseup', ()=>{
                    input.children[i].children[j].style.backgroundColor = 'white'
                    lampBtn.style.backgroundColor = 'lemonchiffon'

                    rotate()
                    update()
                })
            }
        }
 
    </script>
</html>